const CLEAR_TIMEOUT=2e3,HOST_IP=window.location.host,tabs=document.getElementsByClassName("tab"),message=document.getElementById("message"),message_con=document.getElementsByClassName("message")[0],mqtt_host=document.getElementById("mqtt_host"),mqtt_port=document.getElementById("mqtt_port"),mqtt_token=document.getElementById("mqtt_token"),mqtt_id=document.getElementById("mqtt_id"),mqtt_pass=document.getElementById("mqtt_pass"),tele_interval=document.getElementById("tele_interval"),attr_interval=document.getElementById("attr_interval"),save_config=document.getElementById("save_config"),gen_mqtt_id=document.getElementById("gen_mqtt_id"),wifi_list=document.getElementById("wifi_list"),esp_wifi=document.getElementById("esp_wifi"),esp_pass=document.getElementById("esp_pass"),show_pass=document.getElementById("show_pass"),submit_wifi=document.getElementById("submit_wifi"),esp_firmware=document.getElementById("esp_firmware"),submit_firmware=document.getElementById("submit_firmware"),exit=document.getElementById("exit"),restart=document.getElementById("restart"),erase=document.getElementById("erase"),generateClientID=()=>{let e="";const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=t.length;let n=0;for(;n<20;)e+=t.charAt(Math.floor(Math.random()*s)),n+=1;return e},getMqttConfig=()=>{fetch(`http://${HOST_IP}/configinfo`,{method:"GET"}).then(e=>(message_con.style.display="block",message.innerText=e.statusText,setTimeout(clear_message,CLEAR_TIMEOUT),e.json())).then(e=>{mqtt_host.value=e.mqtt_host,mqtt_port.value=e.mqtt_port,mqtt_token.value=e.mqtt_token,mqtt_id.value=e.mqtt_id,mqtt_pass.value=e.mqtt_pass,tele_interval.value=e.tele_interval,attr_interval.value=e.attr_interval})},getWiFi=()=>{fetch(`http://${HOST_IP}/wifi`,{method:"GET"}).then(e=>(message_con.style.display="block",message.innerText=e.statusText,setTimeout(clear_message,CLEAR_TIMEOUT),e.json())).then(e=>{let t="<tr><th>SSID</th><th>SIGNAL</th><th>SECURITY</th></tr>";for(const n of e)t+=`<tr ssid-data="${n.ssid}" onclick="fillSSID(this)"><td>${n.ssid}</td><td>${n.quality}</td><td>${n.encrytion}</td></tr>`;wifi_list.innerHTML=t})};document.querySelectorAll("input[name=tab]").forEach(e=>{e.onclick=e=>{for(const e of tabs)e.style.display="none";e.target.checked&&(document.getElementsByClassName(e.target.value)[0].style.display="block",e.target.value==="MQTT"?getMqttConfig():e.target.value==="WiFi"&&getWiFi())}}),save_config.onclick=()=>{const e=new URLSearchParams;e.append("mqtt_host",mqtt_host.value),e.append("mqtt_port",mqtt_port.value),e.append("mqtt_token",mqtt_token.value),e.append("mqtt_id",mqtt_id.value),e.append("mqtt_pass",mqtt_pass.value),e.append("tele_interval",tele_interval.value),e.append("attr_interval",attr_interval.value),fetch(`http://${HOST_IP}/configsave?${e.toString()}`,{method:"GET"}).then(e=>(message_con.style.display="block",setTimeout(clear_message,CLEAR_TIMEOUT),e.json())).then(e=>{message.innerText=e.message})},submit_wifi.onclick=()=>{const e=new URLSearchParams;e.append("ssid",esp_wifi.value),e.append("pass",esp_pass.value),fetch(`http://${HOST_IP}/wifisave?${e.toString()}`,{method:"GET"}).then(e=>(message_con.style.display="block",setTimeout(clear_message,CLEAR_TIMEOUT),e.json())).then(e=>{message.innerText=e.message})},show_pass.onchange=()=>{show_pass.checked?esp_pass.type="text":esp_pass.type="password"},gen_mqtt_id.onclick=()=>{mqtt_id.value=generateClientID()},esp_firmware.onchange=()=>{submit_firmware.style.display="initial"},submit_firmware.onclick=async()=>{const e=new FormData;e.append("update",esp_firmware.files[0]),await fetch(`http://${HOST_IP}/update`,{method:"POST",body:e}).then(e=>(message_con.style.display="block",setTimeout(clear_message,CLEAR_TIMEOUT),e.json())).then(e=>{message.innerText=e.message})},exit.onclick=()=>{fetch(`http://${HOST_IP}/exit`,{method:"GET"}).then(e=>(message_con.style.display="block",setTimeout(clear_message,CLEAR_TIMEOUT),e.json())).then(e=>{message.innerText=e.message})},restart.onclick=()=>{fetch(`http://${HOST_IP}/restart`,{method:"GET"}).then(e=>(message_con.style.display="block",setTimeout(clear_message,CLEAR_TIMEOUT),e.json())).then(e=>{message.innerText=e.message})},erase.onclick=()=>{fetch(`http://${HOST_IP}/erase`,{method:"GET"}).then(e=>(message_con.style.display="block",setTimeout(clear_message,CLEAR_TIMEOUT),e.json())).then(e=>{message.innerText=e.message})};const tab_handle=()=>{const e=document.querySelector("input[name=tab]:checked").value;for(const e of tabs)e.style.display="none";document.getElementsByClassName(e)[0].style.display="block",getMqttConfig()},clear_message=()=>{message.innerText="",message_con.style.display="none"},fillSSID=e=>{esp_wifi.value=e.getAttribute("ssid-data")};tab_handle()